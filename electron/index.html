<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Readeef feed reader</title>
  </head>
  <body>
    <h1>Please enter the url of your readeef server:</h1>
	<form id="form">
		<input name="server" placeholder="readeef url"><input type="submit"><br>
		<label id="notifications-label" style="display:none;">
			<input type="checkbox" name="notifications">Show notifications
		</label>
	</form>
    <script>
var electron = require('electron');
var checker = require('./url-checker');
var form = document.getElementById('form');

var result = JSON.parse(electron.ipcRenderer.sendSync('get-config-item-sync', "url"));
if (result.success && result.value) {
	form.server.value = result.value;
}

if (location.search.indexOf('initial') == -1) {
	var result = JSON.parse(electron.ipcRenderer.sendSync('get-config-item-sync', "show-notifications"));
	document.getElementById('notifications-label').style.display = '';
	if (result.success) {
		form.notifications.checked = result.value === null || result.value;
	}
}

form.addEventListener('submit', function(event) {
	event.preventDefault();

	var url = form.server.value;
	if (url) {
		checker.Check(url).then(
			function(result) {
				electron.ipcRenderer.send('set-config-item-sync', "url", url);

				electron.remote.getCurrentWindow().loadURL(url);
			}, function(statusText) {
				alert("The url '" + url + "' isn't valid");

				throw new Error("Error checking url " + url + ": " + statusText);
			}
		);
	} else {
		electron.ipcRenderer.send('set-config-item-sync', "url", '');
		electron.remote.getCurrentWindow().loadURL('file://' + __dirname + '/index.html?initial');
	}
});

form.notifications.addEventListener('change', function(event) {
	electron.ipcRenderer.send('set-config-item-sync', "show-notifications", form.notifications.checked);
	electron.ipcRenderer.send('reload-main-window');
});
	</script>
  </body>
</html>
